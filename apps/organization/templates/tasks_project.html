{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load jformat %}

{% block title %}کانبان{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/jkanban/jkanban.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/quill/typography.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/quill/katex.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/quill/editor.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'libs/jdate/jdate.min.js' %}"></script>
  <script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
  <script src="{% static 'libs/flatpickr/flatpickr-jdate.js' %}"></script>
  <script src="{% static 'libs/flatpickr-jalali/dist/l10n/fa.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
  <script src="{% static 'libs/select2/i18n/fa.js' %}"></script>
  <script src="{% static 'vendor/libs/jkanban/jkanban.js' %}"></script>
  <script src="{% static 'vendor/libs/quill/katex.js' %}"></script>
  <script src="{% static 'vendor/libs/quill/quill.js' %}"></script>
{% endblock vendor_js %}

{% block page_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/css/pages/app-kanban.css' %}" />
{% endblock page_css %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/app-kanban.js' %}"></script>
  <script>
    (function() {
      const percentRange = document.getElementById('taskPercent');
      const percentOutput = document.getElementById('taskPercentValue');

      if (percentRange && percentOutput) {
        // مقدار اولیه
        percentOutput.textContent = percentRange.value + '%';

        // آپدیت هنگام حرکت اسلایدر
        percentRange.addEventListener('input', function() {
          percentOutput.textContent = this.value + '%';
        });
      }
    })();
  </script>
{% endblock page_js %}

{% block content %}
  <div class="app-kanban">
    <!-- Kanban Wrapper -->
    <div class="kanban-wrapper"></div>
    <!-- Edit Task & Activities -->
    <div class="offcanvas offcanvas-end kanban-update-item-sidebar">
      <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title">ویرایش تسک</h5>
        <button aria-label="بستن" class="btn-close" data-bs-dismiss="offcanvas" type="button"></button>
      </div>
      <div class="offcanvas-body">
        <div class="tab-content px-0 pb-0">
          <div class="tab-pane fade show active" id="tab-update" role="tabpanel">
            <form id="taskForm">
              <h6 class="fw-bold mb-3">اطلاعات تسک</h6>

              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="title">عنوان تسک</label>
                  <input
                    name="title"
                    class="form-control"
                    id="title"
                    placeholder="عنوان را وارد کنید"
                    type="text"
                  />
                </div>

                <!-- سررسید -->
                <div class="col-md-6">
                  <label class="form-label" for="due-date">سررسید</label>
                  {% if user.role != "user" %}
                    <input
                      name="deadline"
                      class="form-control"
                      id="due-date"
                      placeholder="تاریخ سررسید را وارد کنید"
                      type="text"
                      disabled
                    />
                  {% else %}
                    <input
                      name="deadline"
                      class="form-control"
                      id="due-date"
                      placeholder="تاریخ سررسید را وارد کنید"
                      type="text"
                    />
                  {% endif %}
                </div>

                <!-- وضعیت -->
                <div class="col-md-6">
                  <label class="form-label" for="status">وضعیت</label>
                  <select name="status" class="select2 select2-label form-select" id="status">
                    <option data-color="bg-label-secondary" value="not_started" selected>تازه اضافه شده</option>
                    <option data-color="bg-label-warning" value="in_progress">در حال انجام</option>
                    <option data-color="bg-label-info" value="reviewing">در حال بررسی</option>
                    <option data-color="bg-label-primary" value="completed">تکمیل شده</option>
                  </select>
                </div>

                <!-- درصد پیشرفت -->
                <div class="col-md-8">
                  <label class="form-label" for="percent">درصد پیشرفت</label>
                  <div class="d-flex align-items-center">
                    <input
                      type="range"
                      class="form-range me-3"
                      id="percent"
                      name="percent"
                      min="0"
                      max="100"
                      step="1"
                      value="40"
                    />
                    <span class="fw-bold" id="taskPercentValue">40%</span>
                  </div>
                </div>

                <!-- وزن تسک (۱ تا ۱۰) -->
                <div class="col-md-4">
                  <label class="form-label" for="taskWeight">وزن تسک</label>
                  <div class="input-group input-group-merge">
                    <input
                      type="number"
                      class="form-control text-center"
                      id="taskWeight"
                      name="weight"
                      min="1"
                      max="10"
                      step="1"
                      value="1"
                    />
                    <span class="input-group-text">۱–۱۰</span>
                  </div>
                  <div class="form-text">
                    ۱ = کم‌اهمیت، ۱۰ = خیلی مهم
                  </div>
                </div>
              </div>

              <hr class="my-4">

              <!-- بخش ۲: تیم و بازه‌ی پروژه -->
              <h6 class="fw-bold mb-3">تیم و بازه زمانی پروژه</h6>

              <div class="row g-3">
                <!-- اعضای پروژه -->
                <div class="col-12">
                  <label class="form-label" for="assigneesSelect">اعضای پروژه</label>
                  <div class="select2-success">
                    <select
                      class="select2 form-select"
                      id="assigneesSelect"
                      name="assignees"
                      multiple
                    >
                      {# نمونه: در جنگو #}
                      {#
                      {% for u in project_members %}
                        <option value="{{ u.id }}"
                                {% if u in task.assignees.all %}selected{% endif %}>
                          {{ u.first_name }} {{ u.last_name }}
                        </option>
                      {% endfor %}
                      #}
                      <option value="user.id">user.first_name user.last_name</option>
                    </select>
                  </div>
                </div>

                <!-- تاریخ شروع و پایان پروژه (فقط نمایش) -->
                <div class="col-md-6">
                  <div class="border rounded-2 p-3 h-100">
                    <small class="text-muted d-block mb-1">تاریخ شروع پروژه</small>
                    <span class="fw-semibold">
          1404/09/25
          {# در عمل: {{ project.start_date_jalali }} یا هر متغیر واقعی #}
        </span>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="border rounded-2 p-3 h-100">
                    <small class="text-muted d-block mb-1">تاریخ پایان پروژه</small>
                    <span class="fw-semibold">
          1404/10/25
          {# در عمل: {{ project.end_date_jalali }} #}
        </span>
                  </div>
                </div>
              </div>

              <hr class="my-4">

              <!-- بخش ۳: اطلاعات ثبت/ویرایش -->
              <h6 class="fw-bold mb-3">اطلاعات ثبت تسک</h6>

              <div class="row g-3">
                <div class="col-md-4 col-sm-6">
                  <div class="border rounded-2 p-3 h-100">
                    <small class="text-muted d-block mb-1">ایجاد شده توسط</small>
                    <span class="fw-semibold">
          created_by
          {# در عمل: {{ task.created_by.get_full_name|default:task.created_by.username }} #}
        </span>
                  </div>
                </div>

                <div class="col-md-4 col-sm-6">
                  <div class="border rounded-2 p-3 h-100">
                    <small class="text-muted d-block mb-1">تاریخ ایجاد</small>
                    <span class="fw-semibold">
          created_at
          {# در عمل: {{ task.created_at|date:"Y/m/d H:i" }} #}
        </span>
                  </div>
                </div>

                <div class="col-md-4 col-sm-6">
                  <div class="border rounded-2 p-3 h-100">
                    <small class="text-muted d-block mb-1">آخرین به‌روزرسانی</small>
                    <span class="fw-semibold">
          updated_at
          {# در عمل: {{ task.updated_at|date:"Y/m/d H:i" }} #}
        </span>
                  </div>
                </div>
              </div>

              <!-- اگر بعداً خواستی بخش کامنت را برگردانی، اینجا زیر این بخش بذار -->

              <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-primary me-3" data-bs-dismiss="offcanvas" type="button">
                  به‌روزرسانی
                </button>
                <button class="btn btn-label-danger" data-bs-dismiss="offcanvas" type="button">
                  حذف
                </button>
              </div>
            </form>
          </div>
          <!-- Activities -->
          <div class="tab-pane fade" id="tab-activity" role="tabpanel">

          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
